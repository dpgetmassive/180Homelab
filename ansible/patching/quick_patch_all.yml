---
- name: Quick Patch All Infrastructure
  hosts: all
  gather_facts: yes
  serial: 3  # Patch 3 hosts at a time
  
  tasks:
    - name: Update apt cache (Debian/Ubuntu/Proxmox)
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      
    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      when: ansible_os_family == "Debian"
      register: upgrade_result
      
    - name: Check if reboot required
      stat:
        path: /var/run/reboot-required
      register: reboot_required
      when: ansible_os_family == "Debian"
      
    - name: Display upgrade summary
      debug:
        msg: |
          Host: {{ inventory_hostname }}
          Packages upgraded: {{ upgrade_result.stdout_lines | default([]) | length }}
          Reboot required: {{ reboot_required.stat.exists | default(false) }}

- name: Patch LXC Containers via pct exec
  hosts: pve-scratchy
  gather_facts: no
  
  tasks:
    - name: Get list of running containers
      shell: "pct list | awk 'NR>1 && $2==\"running\" {print $1}'"
      register: running_cts
      changed_when: false
      
    - name: Update and upgrade running containers
      shell: |
        pct exec {{ item }} -- bash -c '
          apt-get update && 
          DEBIAN_FRONTEND=noninteractive apt-get upgrade -y && 
          apt-get autoremove -y && 
          apt-get autoclean
        '
      loop: "{{ running_cts.stdout_lines }}"
      register: ct_upgrade
      changed_when: "'upgraded' in ct_upgrade.stdout"
      
    - name: Check which containers need reboot
      shell: "pct exec {{ item }} -- test -f /var/run/reboot-required && echo {{ item }} || true"
      loop: "{{ running_cts.stdout_lines }}"
      register: ct_reboot_check
      changed_when: false
      
    - name: Display containers needing reboot
      debug:
        msg: "Containers needing reboot: {{ ct_reboot_check.results | selectattr('stdout', 'defined') | selectattr('stdout', '!=', '') | map(attribute='stdout') | list }}"
